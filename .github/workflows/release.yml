name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0, 1.2.3)'
        required: true
        type: string

permissions:
  contents: write  # Required for creating releases and tags

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: public.ecr.aws/apama/apama-builder:latest
      options: --user 0

    env:
      ANALYTICS_BUILDER_SDK: ${{ github.workspace }}/analytics-builder-block-sdk

    outputs:
      version: ${{ steps.version.outputs.normalized }}

    steps:
      # Step 1: Checkout repositories
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout Analytics Builder SDK
        uses: actions/checkout@v4
        with:
          repository: Cumulocity-IoT/apama-analytics-builder-block-sdk
          path: analytics-builder-block-sdk

      # Step 2: Normalize and validate version
      - name: Normalize version format
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # Add 'v' prefix if not present
          if [[ ! "$VERSION" =~ ^v ]]; then
            VERSION="v$VERSION"
          fi
          echo "normalized=$VERSION" >> $GITHUB_OUTPUT
          echo "Normalized version: $VERSION"

      # Step 3: Run tests before building
      - name: Run PySys tests
        run: |
          cd tests
          pysys run

      # Step 4: Create artifacts directory
      - name: Prepare artifacts directory
        run: mkdir -p release-artifacts

      # Step 5: Build all extension bundles
      - name: Build contrib-blocks bundle
        run: |
          ./analytics-builder-block-sdk/analytics_builder build extension \
            --input blocks/ \
            --output release-artifacts/contrib-blocks-${{ steps.version.outputs.normalized }}.zip
          echo "Built: contrib-blocks-${{ steps.version.outputs.normalized }}.zip"

      - name: Build contrib-cumulocity-blocks bundle
        run: |
          ./analytics-builder-block-sdk/analytics_builder build extension \
            --input cumulocity-blocks/ \
            --output release-artifacts/contrib-cumulocity-blocks-${{ steps.version.outputs.normalized }}.zip
          echo "Built: contrib-cumulocity-blocks-${{ steps.version.outputs.normalized }}.zip"

      - name: Build contrib-service-request-blocks bundle
        run: |
          ./analytics-builder-block-sdk/analytics_builder build extension \
            --input service-request-blocks/ \
            --output release-artifacts/contrib-service-request-blocks-${{ steps.version.outputs.normalized }}.zip
          echo "Built: contrib-service-request-blocks-${{ steps.version.outputs.normalized }}.zip"

      - name: Build contrib-simulation-blocks bundle
        run: |
          ./analytics-builder-block-sdk/analytics_builder build extension \
            --input simulation-blocks/ \
            --output release-artifacts/contrib-simulation-blocks-${{ steps.version.outputs.normalized }}.zip
          echo "Built: contrib-simulation-blocks-${{ steps.version.outputs.normalized }}.zip"

      # Step 6: Build individual blocks
      - name: Build individual blocks
        run: |
          echo "Building individual blocks..."
          BLOCK_COUNT=0

          # Build individual blocks from each directory
          for dir in blocks cumulocity-blocks service-request-blocks simulation-blocks; do
            if [ -d "$dir" ]; then
              for block_file in "$dir"/*.mon; do
                if [ -f "$block_file" ]; then
                  block_name=$(basename "$block_file" .mon)

                  # Create temp directory for single block
                  temp_dir="temp-${block_name}"
                  mkdir -p "$temp_dir"
                  cp "$block_file" "$temp_dir/"

                  # Build individual block zip
                  ./analytics-builder-block-sdk/analytics_builder build extension \
                    --input "$temp_dir/" \
                    --output "release-artifacts/${block_name}-${{ steps.version.outputs.normalized }}.zip"

                  # Clean up temp directory
                  rm -rf "$temp_dir"

                  BLOCK_COUNT=$((BLOCK_COUNT + 1))
                  echo "  Built: ${block_name}"
                fi
              done
            fi
          done

          echo ""
          echo "Built $BLOCK_COUNT individual blocks"
      
      # Step 7: Validate Build
      - name: Verify build artifacts
        run: |
          echo "=== Release Artifacts ==="
          ls -lh release-artifacts/
          echo ""

          # Check all 4 bundles exist
          for bundle in contrib-blocks contrib-cumulocity-blocks contrib-service-request-blocks contrib-simulation-blocks; do
            if [ ! -f "release-artifacts/${bundle}-${{ steps.version.outputs.normalized }}.zip" ]; then
              echo "Error: Missing artifact ${bundle}-${{ steps.version.outputs.normalized }}.zip"
              exit 1
            fi
          done

          # Check count of individual blocks
          BLOCK_COUNT=0
          for dir in blocks cumulocity-blocks service-request-blocks simulation-blocks; do
            if [ -d "$dir" ]; then
              for block_file in "$dir"/*.mon; do
                if [ -f "$block_file" ]; then
                  BLOCK_COUNT=$((BLOCK_COUNT + 1))
                fi
              done
            fi
          done

          ZIP_COUNT=$(ls release-artifacts/*.zip | wc -l)
          EXPECTED_ZIP_COUNT=$((BLOCK_COUNT + 4))

          echo "Block count: $BLOCK_COUNT"
          echo "Expected ZIP count: $EXPECTED_ZIP_COUNT (blocks + 4 bundles)"
          echo "Actual ZIP count: $ZIP_COUNT"

          if [ $ZIP_COUNT -ne $EXPECTED_ZIP_COUNT ]; then
            echo ""
            echo "Error: Mismatch in block count"
            exit 1
          fi

          echo "All artifacts validated successfully"    
      # Step 8: Upload artifacts for release job
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-bundles
          path: release-artifacts/*.zip
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository for git operations
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for tagging

      # Step 2: Check if tag already exists
      - name: Check for existing tag
        run: |
          if git rev-parse "${{ needs.build.outputs.version }}" >/dev/null 2>&1; then
            echo "Error: Tag ${{ needs.build.outputs.version }} already exists"
            exit 1
          fi

      # Step 3: Create and push git tag
      - name: Create and push git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ needs.build.outputs.version }} -m "Release ${{ needs.build.outputs.version }}"
          git push origin ${{ needs.build.outputs.version }}

      # Step 4: Download build artifacts
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-bundles
          path: release-artifacts

      # Step 5: Create GitHub release and upload artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: Release ${{ needs.build.outputs.version }}
          body: |
            ## Analytics Builder Blocks Contribution - Release ${{ needs.build.outputs.version }}

            ### Installation

            Download the desired bundle(s) and install to your Cumulocity tenant using:

            ```bash
            . /opt/cumulocity/Apama/bin/apama_env

            ./analytics_builder build extension \
              --input <downloaded-bundle.zip> \
              --cumulocity_url https://$TENANT/ \
              --username $USERNAME \
              --password $PASSWORD \
              --restart
            ```

            ### Requirements
            - Cumulocity IoT tenant with apama-ctrl microservice
            - Analytics Builder Block SDK

            ### Full Changelog
            See commit history for detailed changes since the last release.
          draft: false
          prerelease: ${{ contains(needs.build.outputs.version, 'alpha') || contains(needs.build.outputs.version, 'beta') || contains(needs.build.outputs.version, 'rc') }}
          files: release-artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
